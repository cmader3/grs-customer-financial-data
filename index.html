<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWM Region Customer Financial Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .login-box p {
            color: #666;
            margin-bottom: 20px;
        }

        .login-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .login-box input:focus {
            border-color: #3a7bd5;
            outline: none;
        }

        .login-box button {
            width: 100%;
            padding: 12px 25px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
        }

        .login-box button:hover {
            transform: scale(1.02);
        }

        .login-error {
            color: #ef4444;
            margin-top: 10px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .header-logo {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .controls label {
            font-weight: 600;
            color: #fff;
        }

        .controls input, .controls select {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            font-size: 1em;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .controls input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .controls button {
            padding: 10px 25px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .controls button:hover {
            transform: scale(1.05);
        }

        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-grid-2col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #1a1a2e;
            font-size: 1.3em;
            border-bottom: 3px solid #3a7bd5;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background: #1a1a2e;
            color: white;
            position: sticky;
            top: 0;
        }

        table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
        }

        table th:hover {
            background: #3a7bd5;
        }

        table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        table tbody tr:hover {
            background: #f0f7ff;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .stock-price {
            font-weight: bold;
            color: #1a1a2e;
        }

        .stock-legend-controls {
            margin-bottom: 10px;
        }

        .legend-btn {
            padding: 6px 12px;
            margin-right: 8px;
            background: #3a7bd5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .legend-btn:hover {
            background: #2a6bc5;
        }

        .stock-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            border-color: #3a7bd5;
        }

        .legend-item.unchecked {
            opacity: 0.4;
        }

        .legend-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #666;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .legend-checkbox.checked {
            background: #3a7bd5;
            border-color: #3a7bd5;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-label {
            font-size: 0.85em;
            font-weight: 500;
            color: #333;
        }

        .legend-item[data-tooltip] {
            position: relative;
        }

        .legend-item[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a2e;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .legend-item[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1a1a2e;
            margin-bottom: -5px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .dashboard-grid-2col {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>GWM Dashboard</h2>
            <p>Please enter the password to access this dashboard</p>
            <input type="password" id="passwordInput" placeholder="Enter password..." onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">Access Dashboard</button>
            <p id="loginError" class="login-error">Incorrect password. Please try again.</p>
        </div>
    </div>

    <div id="dashboardContent" class="container hidden">
        <div class="header">
            <img src="grs-logo.png" alt="GRS Team Logo" class="header-logo">
            <h1>GRS Region Customer Financial Performance</h1>
            <p>Real-time tracking of stock performance and key financial metrics</p>
        </div>

        <div class="controls">
            <div>
                <label for="companyFilter">Search: </label>
                <input type="text" id="companyFilter" placeholder="Company name or ticker...">
            </div>
            
            <div>
                <label for="timeframeSelect">Timeframe: </label>
                <select id="timeframeSelect">
                    <option value="1m">1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="6m">6 Months</option>
                    <option value="1y" selected>1 Year</option>
                    <option value="3y">3 Years</option>
                    <option value="5y">5 Years</option>
                </select>
            </div>

            <div>
                <label for="aeSelect">Account Executive: </label>
                <select id="aeSelect">
                    <option value="all">All Account Executives</option>
                    <option value="Annie Kaufmann">Annie Kaufmann</option>
                    <option value="John Paul Bobay">John Paul Bobay</option>
                    <option value="Johnny Marciano">Johnny Marciano</option>
                    <option value="Karan Sharma">Karan Sharma</option>
                    <option value="Marcela Sosa">Marcela Sosa</option>
                    <option value="Tyler Fox">Tyler Fox</option>
                </select>
            </div>

            <button onclick="refreshData()">Refresh</button>
        </div>

        <div class="metrics-summary">
            <div class="metric-box">
                <div class="metric-label">Total Companies</div>
                <div class="metric-value" id="totalCompanies">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Total Market Cap</div>
                <div class="metric-value" id="totalMarketCap">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Avg P/E Ratio</div>
                <div class="metric-value" id="avgPE">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Avg Profit Margin</div>
                <div class="metric-value" id="avgProfitMargin">--</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Avg Growth Rate</div>
                <div class="metric-value" id="avgGrowth">--</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>Stock Price Performance (Historical Closing Prices) 
                    <span style="float:right;">
                        <small style="color:#666;font-weight:normal;margin-right:10px;">Ctrl+Scroll to zoom, drag to pan</small>
                        <button onclick="resetZoom()" style="padding:5px 12px;font-size:0.8em;background:#3a7bd5;color:white;border:none;border-radius:4px;cursor:pointer;">Reset Zoom</button>
                    </span>
                </h2>
                <div class="stock-legend-controls">
                    <button onclick="selectAllStocks()" class="legend-btn">Select All</button>
                    <button onclick="removeAllStocks()" class="legend-btn">Remove All</button>
                </div>
                <div id="stockLegend" class="stock-legend"></div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-grid-2col">
            <div class="card">
                <h2>Top 10 by Market Cap</h2>
                <div class="chart-container">
                    <canvas id="marketCapChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Top 10 by YTD Change</h2>
                <div class="chart-container">
                    <canvas id="changeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Detailed Company Metrics</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')">Company</th>
                            <th onclick="sortTable('exchange')">Exchange</th>
                            <th onclick="sortTable('stockPrice')">Stock Price</th>
                            <th onclick="sortTable('change')">YTD Change</th>
                            <th onclick="sortTable('change52w')">52W Change</th>
                            <th onclick="sortTable('marketCap')">Market Cap (B)</th>
                            <th onclick="sortTable('revenue')">Revenue (B)</th>
                            <th onclick="sortTable('profitMargin')">Profit Margin</th>
                            <th onclick="sortTable('growthRate')">Growth Rate</th>
                            <th onclick="sortTable('peRatio')">P/E Ratio</th>
                        </tr>
                    </thead>
                    <tbody id="metricsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PASSWORD CONFIGURATION - Change this password!
        // ============================================
        const DASHBOARD_PASSWORD = 'grs2026';
        // ============================================

        let companiesData = [];
        let filteredData = [];
        let priceChart = null;
        let marketCapChart = null;
        let changeChart = null;
        let sortColumn = 'marketCap';
        let sortAsc = false;
        let isAuthenticated = false;

        // Check if already authenticated (session storage)
        function checkAuth() {
            if (sessionStorage.getItem('dashboardAuth') === 'true') {
                showDashboard();
            }
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === DASHBOARD_PASSWORD) {
                sessionStorage.setItem('dashboardAuth', 'true');
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function showDashboard() {
            isAuthenticated = true;
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            loadData();
        }

        async function loadData() {
            try {
                const response = await fetch('company_data.json?t=' + Date.now());
                companiesData = await response.json();
                filteredData = [...companiesData];
                console.log('Loaded ' + companiesData.length + ' companies with real data');
                updateDisplay();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function formatDateLabels(dates, timeframe) {
            // Format actual dates from the data based on timeframe
            return dates.map(dateStr => {
                const date = new Date(dateStr);
                if (timeframe === '1m' || timeframe === '3m') {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } else if (timeframe === '6m' || timeframe === '1y') {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            });
        }

        function getExchangeName(code) {
            const exchanges = {
                'NMS': 'NASDAQ',
                'NGM': 'NASDAQ GM',
                'NYQ': 'NYSE',
                'PNK': 'OTC Pink',
                'OQX': 'OTCQX',
                'N/A': 'N/A'
            };
            return exchanges[code] || code || 'N/A';
        }

        function getColor(index) {
            const colors = [
                '#3a7bd5', '#00d2ff', '#764ba2', '#667eea', '#f093fb',
                '#f5576c', '#4facfe', '#43e97b', '#fa709a', '#fee140',
                '#30cfd0', '#c471ed', '#12c2e9', '#f64f59', '#c471ed'
            ];
            return colors[index % colors.length];
        }

        // Track which stocks are visible
        let stockVisibility = {};

        function initPriceChart() {
            const timeframe = document.getElementById('timeframeSelect').value;
            const historyKey = 'history_' + timeframe;
            const datesKey = 'dates_' + timeframe;
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Get all filtered companies with history data, sorted by market cap
            const chartCompanies = [...filteredData]
                .filter(c => c[historyKey] && c[historyKey].length > 0)
                .sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
            
            if (chartCompanies.length === 0) return;
            
            // Initialize visibility for new stocks (default to visible)
            chartCompanies.forEach(company => {
                if (stockVisibility[company.ticker] === undefined) {
                    stockVisibility[company.ticker] = true;
                }
            });
            
            // Find the company with the longest history to use as the x-axis baseline
            const companyWithLongestHistory = chartCompanies.reduce((longest, company) => {
                const dates = company[datesKey] || [];
                const longestDates = longest[datesKey] || [];
                return dates.length > longestDates.length ? company : longest;
            }, chartCompanies[0]);
            
            const baselineDates = companyWithLongestHistory[datesKey] || [];
            const allLabels = formatDateLabels(baselineDates, timeframe);
            
            const datasets = chartCompanies.map((company, index) => {
                const companyDates = company[datesKey] || [];
                const companyPrices = company[historyKey] || [];
                
                // Create a map of date -> price for this company
                const dateToPrice = {};
                companyDates.forEach((date, i) => {
                    dateToPrice[date] = companyPrices[i];
                });
                
                // Align company data to ALL baseline dates
                // Use null for dates before the company was listed
                const alignedData = baselineDates.map(date => {
                    return dateToPrice[date] !== undefined ? dateToPrice[date] : null;
                });
                
                return {
                    label: company.ticker,
                    data: alignedData,
                    borderColor: getColor(index),
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHitRadius: 10,
                    tension: 0.1,
                    hidden: !stockVisibility[company.ticker],
                    spanGaps: false
                };
            });

            // Build custom legend
            buildStockLegend(chartCompanies);

            if (priceChart) priceChart.destroy();

            priceChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allLabels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: true },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const ticker = items[0].dataset.label;
                                    const company = filteredData.find(c => c.ticker === ticker);
                                    return company?.name || ticker;
                                },
                                label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toFixed(2)} (${ctx.label})`
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'y'
                            },
                            zoom: {
                                wheel: { 
                                    enabled: true,
                                    modifierKey: 'ctrl'
                                },
                                pinch: { enabled: true },
                                mode: 'y'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Closing Price ($)' }
                        },
                        x: {
                            title: { display: true, text: 'Date' },
                            ticks: {
                                maxTicksLimit: 20,
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        let legendExpanded = false;
        let allLegendCompanies = [];

        function buildStockLegend(companies) {
            allLegendCompanies = companies;
            const legendContainer = document.getElementById('stockLegend');
            const displayCompanies = legendExpanded ? companies : companies.slice(0, 10);
            const hasMore = companies.length > 10;
            
            let html = displayCompanies.map((company, index) => {
                const isChecked = stockVisibility[company.ticker] !== false;
                return `
                    <div class="legend-item ${isChecked ? '' : 'unchecked'}" onclick="toggleStock('${company.ticker}', ${index})" data-tooltip="${company.name}">
                        <div class="legend-checkbox ${isChecked ? 'checked' : ''}">${isChecked ? '✓' : ''}</div>
                        <div class="legend-color" style="background-color: ${getColor(index)}"></div>
                        <span class="legend-label">${company.ticker}</span>
                    </div>
                `;
            }).join('');
            
            if (hasMore) {
                if (legendExpanded) {
                    html += `<div class="legend-item" onclick="toggleLegendExpand()" style="background:#3a7bd5;color:white;font-weight:600;">
                        <span class="legend-label">Show Less</span>
                    </div>`;
                } else {
                    html += `<div class="legend-item" onclick="toggleLegendExpand()" style="background:#3a7bd5;color:white;font-weight:600;">
                        <span class="legend-label">+${companies.length - 10} More</span>
                    </div>`;
                }
            }
            
            legendContainer.innerHTML = html;
        }

        function toggleLegendExpand() {
            legendExpanded = !legendExpanded;
            buildStockLegend(allLegendCompanies);
        }

        function toggleStock(ticker, datasetIndex) {
            stockVisibility[ticker] = !stockVisibility[ticker];
            
            // Update chart visibility
            if (priceChart) {
                priceChart.data.datasets[datasetIndex].hidden = !stockVisibility[ticker];
                priceChart.update();
            }
            
            // Update legend UI
            const legendItems = document.querySelectorAll('.legend-item');
            const item = legendItems[datasetIndex];
            const checkbox = item.querySelector('.legend-checkbox');
            
            if (stockVisibility[ticker]) {
                item.classList.remove('unchecked');
                checkbox.classList.add('checked');
                checkbox.textContent = '✓';
            } else {
                item.classList.add('unchecked');
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
            }
            
            // Update metrics based on visible stocks
            updateMetrics();
        }

        function selectAllStocks() {
            if (!priceChart) return;
            
            priceChart.data.datasets.forEach((dataset, index) => {
                stockVisibility[dataset.label] = true;
                dataset.hidden = false;
            });
            priceChart.update();
            
            // Update all legend items
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('unchecked');
                const checkbox = item.querySelector('.legend-checkbox');
                checkbox.classList.add('checked');
                checkbox.textContent = '✓';
            });
            
            // Update metrics
            updateMetrics();
        }

        function removeAllStocks() {
            if (!priceChart) return;
            
            priceChart.data.datasets.forEach((dataset, index) => {
                stockVisibility[dataset.label] = false;
                dataset.hidden = true;
            });
            priceChart.update();
            
            // Update all legend items
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.add('unchecked');
                const checkbox = item.querySelector('.legend-checkbox');
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
            });
            
            // Update metrics
            updateMetrics();
        }

        // Store company data for chart tooltips
        let marketCapCompanies = [];
        let changeCompanies = [];

        function initMarketCapChart() {
            const top10 = [...filteredData]
                .filter(c => c.marketCap > 0)
                .sort((a, b) => b.marketCap - a.marketCap)
                .slice(0, 10);
            
            marketCapCompanies = top10;
            const ctx = document.getElementById('marketCapChart').getContext('2d');
            
            if (marketCapChart) marketCapChart.destroy();

            marketCapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(c => c.ticker),
                    datasets: [{
                        label: 'Market Cap (Billions)',
                        data: top10.map(c => c.marketCap),
                        backgroundColor: top10.map((_, i) => getColor(i)),
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0].dataIndex;
                                    return marketCapCompanies[idx]?.name || items[0].label;
                                },
                                label: (ctx) => `$${ctx.parsed.x.toFixed(2)}B`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Market Cap ($B)' }
                        }
                    }
                }
            });
        }

        function initChangeChart() {
            const sorted = [...filteredData]
                .filter(c => c.change !== 0)
                .sort((a, b) => b.change - a.change)
                .slice(0, 10);
            
            changeCompanies = sorted;
            const ctx = document.getElementById('changeChart').getContext('2d');
            
            if (changeChart) changeChart.destroy();

            changeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(c => c.ticker),
                    datasets: [{
                        label: 'YTD Change (%)',
                        data: sorted.map(c => c.change),
                        backgroundColor: sorted.map(c => c.change >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const idx = items[0].dataIndex;
                                    return changeCompanies[idx]?.name || items[0].label;
                                },
                                label: (ctx) => `${ctx.parsed.x >= 0 ? '+' : ''}${ctx.parsed.x.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Change (%)' }
                        }
                    }
                }
            });
        }

        function updateMetrics() {
            // Filter to only visible stocks in the legend
            const visibleTickers = Object.keys(stockVisibility).filter(t => stockVisibility[t]);
            const data = filteredData.filter(c => c.stockPrice > 0 && (visibleTickers.length === 0 || visibleTickers.includes(c.ticker)));
            
            const totalMarketCap = data.reduce((sum, c) => sum + (c.marketCap || 0), 0);
            const avgPE = data.filter(c => c.peRatio > 0).reduce((sum, c) => sum + c.peRatio, 0) / data.filter(c => c.peRatio > 0).length || 0;
            const avgMargin = data.filter(c => c.profitMargin !== 0).reduce((sum, c) => sum + c.profitMargin, 0) / data.filter(c => c.profitMargin !== 0).length || 0;
            const avgGrowth = data.filter(c => c.growthRate !== 0).reduce((sum, c) => sum + c.growthRate, 0) / data.filter(c => c.growthRate !== 0).length || 0;

            document.getElementById('totalCompanies').textContent = data.length;
            const marketCapDisplay = totalMarketCap >= 1000 
                ? '$' + (totalMarketCap / 1000).toFixed(1) + 'T'
                : '$' + totalMarketCap.toFixed(1) + 'B';
            document.getElementById('totalMarketCap').textContent = marketCapDisplay;
            document.getElementById('avgPE').textContent = avgPE.toFixed(1);
            document.getElementById('avgProfitMargin').textContent = avgMargin.toFixed(1) + '%';
            document.getElementById('avgGrowth').textContent = avgGrowth.toFixed(1) + '%';
        }

        function updateTable() {
            const sorted = [...filteredData].sort((a, b) => {
                const aVal = a[sortColumn] || 0;
                const bVal = b[sortColumn] || 0;
                return sortAsc ? aVal - bVal : bVal - aVal;
            });

            const tbody = document.getElementById('metricsTable');
            tbody.innerHTML = sorted.map(c => `
                <tr>
                    <td><strong>${c.name}</strong><br><small style="color:#666">${c.ticker}</small></td>
                    <td>${getExchangeName(c.exchange)}</td>
                    <td class="stock-price">$${c.stockPrice.toFixed(2)}</td>
                    <td class="${c.change >= 0 ? 'positive' : 'negative'}">
                        ${c.change >= 0 ? '+' : ''}${c.change.toFixed(1)}%
                    </td>
                    <td class="${(c.change52w || 0) >= 0 ? 'positive' : 'negative'}">
                        ${(c.change52w || 0) >= 0 ? '+' : ''}${(c.change52w || 0).toFixed(1)}%
                    </td>
                    <td>$${(c.marketCap || 0).toFixed(2)}B</td>
                    <td>$${(c.revenue || 0).toFixed(1)}B</td>
                    <td>${(c.profitMargin || 0).toFixed(1)}%</td>
                    <td class="${(c.growthRate || 0) >= 0 ? 'positive' : 'negative'}">
                        ${(c.growthRate || 0) >= 0 ? '+' : ''}${(c.growthRate || 0).toFixed(1)}%
                    </td>
                    <td>${(c.peRatio || 0).toFixed(1)}</td>
                </tr>
            `).join('');
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortAsc = !sortAsc;
            } else {
                sortColumn = column;
                sortAsc = false;
            }
            updateTable();
        }

        function filterBySearch() {
            const term = document.getElementById('companyFilter').value.toLowerCase();
            const selectedAE = document.getElementById('aeSelect').value;
            
            if (term === '') {
                // No search term, just filter by AE
                filteredData = companiesData.filter(c => {
                    return selectedAE === 'all' || c.accountExec === selectedAE;
                });
            } else {
                // Search term entered - check if it matches within current AE filter
                const matchesInCurrentAE = companiesData.filter(c => {
                    const matchesSearch = c.name.toLowerCase().includes(term) || 
                                         c.ticker.toLowerCase().includes(term);
                    const matchesAE = selectedAE === 'all' || c.accountExec === selectedAE;
                    return matchesSearch && matchesAE;
                });
                
                if (matchesInCurrentAE.length > 0) {
                    // Found matches within current AE filter
                    filteredData = matchesInCurrentAE;
                } else {
                    // No matches in current AE - search all and reset AE dropdown
                    filteredData = companiesData.filter(c => {
                        return c.name.toLowerCase().includes(term) || 
                               c.ticker.toLowerCase().includes(term);
                    });
                    if (filteredData.length > 0) {
                        document.getElementById('aeSelect').value = 'all';
                    }
                }
            }
            
            if (filteredData.length === 0) filteredData = [...companiesData];
            legendExpanded = false; // Reset legend expansion on filter change
            updateDisplay();
        }

        function filterByAE() {
            // Clear search box when AE dropdown changes
            document.getElementById('companyFilter').value = '';
            const selectedAE = document.getElementById('aeSelect').value;
            
            filteredData = companiesData.filter(c => {
                return selectedAE === 'all' || c.accountExec === selectedAE;
            });
            
            if (filteredData.length === 0) filteredData = [...companiesData];
            legendExpanded = false; // Reset legend expansion on filter change
            updateDisplay();
        }

        function updateDisplay() {
            initPriceChart();
            initMarketCapChart();
            initChangeChart();
            updateMetrics();
            updateTable();
        }

        function refreshData() {
            // Reset all filters
            const aeSelect = document.getElementById('aeSelect');
            if (aeSelect) {
                aeSelect.selectedIndex = 0;
            }
            document.getElementById('companyFilter').value = '';
            // Reset stock visibility and legend state
            stockVisibility = {};
            legendExpanded = false;
            loadData();
        }

        function resetZoom() {
            if (priceChart) {
                priceChart.resetZoom();
            }
        }

        // Event listeners
        document.getElementById('companyFilter').addEventListener('input', filterBySearch);
        document.getElementById('timeframeSelect').addEventListener('change', updateDisplay);
        document.getElementById('aeSelect').addEventListener('change', filterByAE);

        // Check authentication on start
        checkAuth();
    </script>
</body>
</html>
